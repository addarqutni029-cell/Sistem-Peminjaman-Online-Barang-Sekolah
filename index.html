<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIPINJOL - Sistem Peminjaman Online Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .splash-icon {
            opacity: 0;
            transform: translateY(50px);
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        /* Style untuk background */
        .bg-login {
            background-color: #000000;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23000000'/%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Ccircle cx='0' cy='0' r='20'/%3E%3Ccircle cx='40' cy='0' r='20'/%3E%3Ccircle cx='80' cy='0' r='20'/%3E%3Ccircle cx='0' cy='40' r='20'/%3E%3Ccircle cx='40' cy='40' r='20'/%3E%3Ccircle cx='80' cy='40' r='20'/%3E%3Ccircle cx='0' cy='80' r='20'/%3E%3Ccircle cx='40' cy='80' r='20'/%3E%3Ccircle cx='80' cy='80' r='20'/%3E%3C/g%3E%3C/svg%3E");
        }
        .bg-dashboard {
            background-color: #000000;
        }
        /* Style untuk kartu profil yang bisa digerakkan */
        #profile-card {
            cursor: grab;
        }
        #profile-card.dragging {
            cursor: grabbing;
            z-index: 30;
        }
        /* Kursor Kustom */
        #cursor-dot, #cursor-outline {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        #cursor-dot {
            width: 8px;
            height: 8px;
            background-color: #2563eb; /* bg-blue-700 */
        }
        #cursor-outline {
            width: 40px;
            height: 40px;
            border: 2px solid #3b82f6; /* bg-blue-600 */
            transition-duration: 0.1s;
        }
        /* Efek hover pada kursor */
        body:has(button:hover, a:hover, input:hover, select:hover) #cursor-outline {
            transform: translate(-50%, -50%) scale(1.5);
            background-color: rgba(59, 130, 246, 0.1);
        }
        body:has(button:active, a:active) #cursor-outline {
             transform: translate(-50%, -50%) scale(0.9);
        }
        /* Sembunyikan kursor default */
        html, body, button, a {
            cursor: none;
        }
        /* Animasi Pelangi untuk Tombol AI */
        @keyframes rainbow-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .rainbow-animate {
            background: linear-gradient(90deg, #f87171, #fb923c, #facc15, #4ade80, #38bdf8, #818cf8, #c084fc);
            background-size: 200% 200%;
            animation: rainbow-bg 5s ease infinite;
            color: white;
            font-weight: bold;
        }
        /* Style Tombol yang Lebih Modern */
        button, .button-style {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        button:hover, .button-style:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        #logout-btn {
            background-image: linear-gradient(to right, #ef4444, #dc2626);
        }
        #modal-close-btn, #ai-ask-btn, #login-form button {
             background-image: linear-gradient(to right, #3b82f6, #2563eb);
        }
        .bg-green-500 {
             background-image: linear-gradient(to right, #22c55e, #16a34a);
        }
        .bg-blue-600 {
             background-image: linear-gradient(to right, #3b82f6, #2563eb);
        }
    </style>
</head>
<body class="bg-slate-100 antialiased">

    <!-- Kursor Kustom -->
    <div id="cursor-dot"></div>
    <div id="cursor-outline"></div>

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-gradient-to-br from-blue-500 to-indigo-600 flex flex-col justify-center items-center z-50 text-white">
        <div class="text-center">
            <div class="flex justify-center items-center space-x-6 mb-6">
                <div class="splash-icon" id="icon1"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open-check"><path d="M8 3H2v15h7c1.7 0 3 1.3 3 3V7c0-2.2-1.8-4-4-4Z"/><path d="M16 3h6v15h-7c-1.7 0-3 1.3-3 3V7c0-2.2 1.8-4 4-4Z"/><path d="m16 12 2 2 4-4"/></svg></div>
                <div class="splash-icon" id="icon2"><svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-graduation-cap"><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.084a1 1 0 0 0 0 1.838l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12.5V16a6 3 0 0 0 12 0v-3.5"/></svg></div>
                <div class="splash-icon" id="icon3"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M18 5a3 3 0 1 0-5.993.142"/><path d="M21 12a3 3 0 1 0 .142-5.993"/><path d="M3 12a3 3 0 1 0 .142-5.993"/><path d="M12 21a3 3 0 1 0 .142-5.993"/><path d="M5.02 17.11a3 3 0 1 0 3.86-3.86"/><path d="M15.12 17.11a3 3 0 1 0 3.86-3.86"/><path d="M9.03 8.85a3 3 0 1 0-3.88 3.88"/><path d="M18.88 9.03a3 3 0 1 0-3.88 3.88"/><path d="M12 12v3m0 3v3m-3-12h3m3 0h3m-12 0H3m3 3 .75.75M12 12l.75.75M12 12l-.75.75m3-.75-.75.75m-1.5-1.5.75.75"/></svg></div>
            </div>
            <h1 class="text-4xl font-bold mb-2 splash-icon" id="title-splash">SIPINJOL</h1>
            <p class="text-xl splash-icon" id="subtitle-splash">Sistem Peminjaman Online Sekolah</p>
        </div>
    </div>

    <!-- Halaman Login -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-login hidden relative">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="max-w-md w-full bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8 m-4 z-10">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Absen Dulu, Yuk!</h2>
            <p class="text-center text-gray-600 mb-8">Masuk ke akun untuk mulai beraktivitas.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                 <div class="mb-6">
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Peran</label>
                    <select id="role" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="siswa">Siswa</option>
                        <option value="guru">Guru</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Masuk Kelas</button>
            </form>
        </div>
    </div>

    <!-- Konten Aplikasi Utama -->
    <div id="app" class="hidden">
        <div class="flex h-screen bg-slate-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
                <div class="p-4 border-b">
                    <h1 class="text-2xl font-bold text-blue-600">SIPINJOL</h1>
                    <p class="text-sm text-gray-500">SMAN 1 Dramaga</p>
                </div>
                <nav id="sidebar-nav" class="p-4 space-y-2 flex-1 overflow-y-auto"></nav>
            </aside>

            <!-- Konten Utama -->
            <main id="main-container" class="flex-1 p-6 overflow-y-auto relative transition-all duration-500">
                 <div class="absolute inset-0 bg-black opacity-0 transition-opacity duration-500" id="main-overlay"></div>
                <div id="main-content" class="relative z-10"></div>
            </main>
        </div>

        <!-- Kartu Profil Pengguna -->
        <div id="profile-card" class="fixed bottom-4 right-4 bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl p-4 w-64 z-20 border border-gray-200">
             <div id="user-profile" class="flex items-center space-x-3 border-b border-gray-200 pb-3 mb-3"></div>
            <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                 <span>Pulang</span>
            </button>
        </div>
    </div>
    
    <!-- Modal Notifikasi -->
    <div id="notification-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Siap!</button>
        </div>
    </div>

    <script>
        // === DATA SIMULASI (Pengganti Database) ===
        const schoolData = {
            users: [
                { id: 'adm01', username: '1234', password: '4321', role: 'admin', name: 'Admin TU' },
                { id: 'guru01', username: '1234', password: '4321', role: 'guru', name: 'Bapak Budi' },
                { id: 'sis01', username: '1234', password: '4321', role: 'siswa', name: 'Siti' },
                { id: 'sis02', username: '1234', password: '4321', role: 'siswa', name: 'Budi' }
            ],
            items: [
                { id: 'item01', name: 'Proyektor Ruang Multimedia', total: 5, available: 3, icon: 'projector' },
                { id: 'item02', name: 'Laptop Chromebook Lab Komputer', total: 20, available: 15, icon: 'laptop-2' },
                { id: 'item03', name: 'Kamera DSLR Ekskul Fotografi', total: 3, available: 1, icon: 'camera' },
                { id: 'item04', name: 'Speaker Aktif Aula', total: 4, available: 4, icon: 'speaker' },
                { id: 'item05', name: 'Bola Basket Lapangan Utama', total: 10, available: 8, icon: 'basketball' },
                { id: 'item06', name: 'Mikroskop Lab Biologi', total: 15, available: 15, icon: 'microscope' }
            ],
            loans: [
                { loanId: 'L001', userId: 'sis01', itemId: 'item01', borrowDate: new Date('2025-09-10T09:00:00'), dueDate: new Date('2025-09-12T17:00:00'), returnDate: null },
                { loanId: 'L002', userId: 'guru01', itemId: 'item02', borrowDate: new Date('2025-09-15T10:00:00'), dueDate: new Date('2025-09-16T17:00:00'), returnDate: null },
                { loanId: 'L003', userId: 'sis01', itemId: 'item03', borrowDate: new Date('2025-09-01T11:00:00'), dueDate: new Date('2025-09-03T17:00:00'), returnDate: new Date('2025-09-03T16:00:00') },
            ],
            announcements: [
                { title: 'Rapat OSIS', content: 'Diadakan pada hari Jumat, 3 Oktober 2025 di Ruang OSIS setelah jam pulang sekolah. Diharapkan kehadiran seluruh anggota.', icon: 'ðŸ“¢' },
                { title: 'Lomba 17 Agustus', content: 'Pendaftaran lomba tarik tambang dan balap karung dibuka hingga tanggal 10 Agustus di meja piket.', icon: 'ðŸ‡®ðŸ‡©' },
                { title: 'Pekan Ulangan Harian', content: 'Akan dilaksanakan mulai minggu depan. Persiapkan diri kalian dan semangat belajar!', icon: 'ðŸ“š' }
            ],
            funFacts: [
                "Kata 'sekolah' berasal dari bahasa Yunani 'skhole' yang artinya waktu luang.",
                "Pensil bisa menulis sekitar 45.000 kata.",
                "Semut tidak pernah tidur dan tidak punya paru-paru.",
                "Otak manusia menghasilkan listrik yang cukup untuk menyalakan sebuah bola lampu kecil.",
                "Indonesia memiliki lebih dari 17.000 pulau, tapi hanya sekitar 6.000 yang berpenghuni."
            ]
        };

        // === KONFIGURASI APLIKASI ===
        const schoolConfig = {
            borrowLimits: {
                siswa: 1,
                guru: 3,
                admin: 99 // Dianggap tak terbatas
            },
            penaltyPerDay: 5000 // Denda per hari keterlambatan
        };

        // === ICONS (Lucide) ===
        const ICONS = {
            dashboard: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`,
            archive: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>`,
            history: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
            file_text: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            help: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>`,
            brain_circuit: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M18 5a3 3 0 1 0-5.993.142"/><path d="M21 12a3 3 0 1 0 .142-5.993"/><path d="M3 12a3 3 0 1 0 .142-5.993"/><path d="M12 21a3 3 0 1 0 .142-5.993"/><path d="M5.02 17.11a3 3 0 1 0 3.86-3.86"/><path d="M15.12 17.11a3 3 0 1 0 3.86-3.86"/><path d="M9.03 8.85a3 3 0 1 0-3.88 3.88"/><path d="M18.88 9.03a3 3 0 1 0-3.88 3.88"/><path d="M12 12v3m0 3v3m-3-12h3m3 0h3m-12 0H3m3 3 .75.75M12 12l.75.75M12 12l-.75.75m3-.75-.75.75m-1.5-1.5.75.75"/></svg>`,
            user: `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-user-round rounded-full bg-gray-200 text-gray-500 p-1"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>`,
            projector: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-projector"><path d="M5 16h14"/><path d="M19 12v-2a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v2"/><circle cx="9" cy="16" r="1"/><circle cx="15" cy="16" r="1"/><path d="M12 8a4 4 0 0 1 4 4h-8a4 4 0 0 1 4-4Z"/></svg>`,
            'laptop-2': `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop-2"><path d="M15 14h.01"/><path d="M12 20h4a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h4"/><line x1="12" x2="12" y1="14" y2="20"/><line x1="8" x2="16" y1="18" y2="18"/></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>`,
            speaker: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-speaker"><rect width="16" height="20" x="4" y="2" rx="2"/><circle cx="12" cy="14" r="4"/><line x1="12" x2="12.01" y1="6" y2="6"/></svg>`,
            basketball: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-basketball"><circle cx="12" cy="12" r="10"/><path d="M12 2a7 7 0 0 0-7 7c0 4.2 3.8 8.4 7 13 3.2-4.6 7-8.8 7-13a7 7 0 0 0-7-7Z"/><path d="M2.5 9.5c5.1 2.4 14.2 2.4 19 0"/></svg>`,
            microscope: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-microscope"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>`,
            kembalikan: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-corner-down-left"><polyline points="9 10 4 15 9 20"/><path d="M20 4v7a4 4 0 0 1-4 4H4"/></svg>`,
        };

        // === APLIKASI UTAMA (Struktur Baru) ===
        const App = {
            // State Aplikasi
            state: {
                currentUser: null,
                loans: schoolData.loans,
                items: schoolData.items
            },
            
            // Elemen DOM
            DOM: {
                splashScreen: document.getElementById('splash-screen'),
                loginPage: document.getElementById('login-page'),
                appPage: document.getElementById('app'),
                loginForm: document.getElementById('login-form'),
                mainContainer: document.getElementById('main-container'),
                mainOverlay: document.getElementById('main-overlay'),
                mainContent: document.getElementById('main-content'),
                sidebarNav: document.getElementById('sidebar-nav'),
                userProfile: document.getElementById('user-profile'),
                logoutBtn: document.getElementById('logout-btn'),
                loginError: document.getElementById('login-error'),
                modal: document.getElementById('notification-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalMessage: document.getElementById('modal-message'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                profileCard: document.getElementById('profile-card')
            },

            // Inisialisasi
            init() {
                this.startSplashScreen();
                this.DOM.loginForm.addEventListener('submit', (e) => this.handlers.handleLogin(e));
                this.DOM.logoutBtn.addEventListener('click', () => this.handlers.handleLogout());
                this.DOM.modalCloseBtn.addEventListener('click', () => this.DOM.modal.classList.remove('show'));
                this.utils.makeDraggable(this.DOM.profileCard);
                this.utils.setupCustomCursor(); // Menambahkan inisialisasi kursor
                this.utils.setupButtonClickAnimation(); // Menambahkan inisialisasi animasi klik
            },

            startSplashScreen() {
                anime.timeline({ easing: 'easeOutExpo' })
                    .add({
                        targets: '.splash-icon, #title-splash, #subtitle-splash',
                        opacity: [0, 1],
                        translateY: [50, 0],
                        delay: anime.stagger(150),
                    });
                
                setTimeout(() => {
                    this.DOM.splashScreen.classList.add('hidden');
                    this.DOM.loginPage.classList.remove('hidden');
                }, 3000);
            },
            
            // Handler untuk Event
            handlers: {
                handleLogin(e) {
                    e.preventDefault();
                    const username = App.DOM.loginForm.username.value;
                    const password = App.DOM.loginForm.password.value;
                    const role = App.DOM.loginForm.role.value;

                    const foundUser = schoolData.users.find(
                        user => user.username === username && user.password === password && user.role === role
                    );

                    if (foundUser) {
                        App.state.currentUser = foundUser;
                        App.DOM.loginPage.classList.add('hidden');
                        App.DOM.appPage.classList.remove('hidden');
                        App.logic.setupApp();
                        App.DOM.loginError.classList.add('hidden');
                    } else {
                        App.DOM.loginError.textContent = 'Username, password, atau peran salah!';
                        App.DOM.loginError.classList.remove('hidden');
                    }
                },
                handleLogout() {
                    App.state.currentUser = null;
                    App.DOM.appPage.classList.add('hidden');
                    App.DOM.loginPage.classList.remove('hidden');
                    App.DOM.loginForm.reset();
                }
            },
            
            // Logika Inti Aplikasi
            logic: {
                setupApp() {
                    App.render.sidebar();
                    App.render.userProfile();
                    App.logic.navigateTo('dashboard');
                    App.logic.checkLateReturns();
                },

                navigateTo(view) {
                    document.querySelectorAll('.sidebar-link').forEach(link => {
                        link.classList.toggle('active', link.dataset.view === view);
                    });

                    const mainContainer = App.DOM.mainContainer;
                    const mainOverlay = App.DOM.mainOverlay;

                    // Daftar semua kelas background yang mungkin
                    const bgClasses = ['bg-dashboard', 'bg-yellow-50', 'bg-green-50', 'bg-orange-50', 'bg-blue-50', 'bg-red-50'];
                    // Hapus semua kelas background yang ada
                    mainContainer.classList.remove(...bgClasses);
                    
                    const isDashboard = view === 'dashboard';
                    mainOverlay.classList.toggle('opacity-50', isDashboard);

                    // Tambahkan kelas background yang sesuai dengan halaman
                    switch(view) {
                        case 'dashboard':
                            mainContainer.classList.add('bg-dashboard');
                            break;
                        case 'pinjam':
                            mainContainer.classList.add('bg-yellow-50');
                            break;
                        case 'kembalikan':
                            mainContainer.classList.add('bg-green-50');
                            break;
                        case 'riwayat': // catatan peminjaman
                            mainContainer.classList.add('bg-orange-50');
                            break;
                        case 'tanya_ai':
                            mainContainer.classList.add('bg-blue-50');
                            break;
                        case 'panduan':
                            mainContainer.classList.add('bg-red-50');
                            break;
                        default:
                            // Tidak perlu menambahkan kelas default karena parent sudah punya bg-slate-100
                            break;
                    }

                    const renderFunction = App.render[view];
                    if (renderFunction) {
                        renderFunction();
                    } else {
                        App.DOM.mainContent.innerHTML = `<p>Halaman tidak ditemukan.</p>`;
                    }

                    anime({
                        targets: '#main-content > *',
                        opacity: [0, 1],
                        translateY: [20, 0],
                        duration: 400,
                        easing: 'easeOutCubic'
                    });
                },

                checkLateReturns() {
                    if (!App.state.currentUser) return;
                    const userLoans = App.state.loans.filter(l => l.userId === App.state.currentUser.id && l.returnDate === null);
                    const lateLoans = userLoans.filter(l => new Date() > l.dueDate);

                    if (lateLoans.length > 0) {
                        const lateItems = lateLoans.map(l => {
                            const item = App.state.items.find(i => i.id === l.itemId);
                            return `<li><b>${item.name}</b> (Jatuh tempo: ${App.utils.formatDate(l.dueDate)})</li>`;
                        }).join('');
                        
                        App.utils.showNotification('Peringatan Keterlambatan!',
                            `Kamu punya ${lateLoans.length} barang yang telat dikembalikan: <ul>${lateItems}</ul> Segera kembalikan ya!`
                        );
                    }
                },
                
                pinjamItem(itemId) {
                    const userRole = App.state.currentUser.role;
                    const borrowLimit = schoolConfig.borrowLimits[userRole];
                    const currentBorrows = App.state.loans.filter(
                        l => l.userId === App.state.currentUser.id && l.returnDate === null
                    ).length;

                    if (currentBorrows >= borrowLimit) {
                        App.utils.showNotification('Kuota Habis!', `Maaf, kamu sudah mencapai batas maksimal peminjaman (${borrowLimit} barang). Kembalikan dulu barang lain untuk meminjam lagi.`);
                        return;
                    }

                    const item = App.state.items.find(i => i.id === itemId);
                    if (item && item.available > 0) {
                        item.available--;
                        const newLoan = {
                            loanId: 'L' + (App.state.loans.length + 1).toString().padStart(3, '0'),
                            userId: App.state.currentUser.id,
                            itemId: itemId,
                            borrowDate: new Date(),
                            dueDate: new Date(new Date().setDate(new Date().getDate() + 3)),
                            returnDate: null
                        };
                        App.state.loans.push(newLoan);
                        App.utils.showNotification('Oke, Dicatat!', `Kamu berhasil meminjam <b>${item.name}</b>. Jangan lupa kembalikan sebelum ${App.utils.formatDate(newLoan.dueDate)}.`);
                        App.render.pinjam();
                    }
                },

                kembalikanItem(loanId) {
                    const loan = App.state.loans.find(l => l.loanId === loanId);
                    if (loan) {
                        const item = App.state.items.find(i => i.id === loan.itemId);
                        const penalty = App.utils.calculatePenalty(loan);
                        loan.returnDate = new Date();
                        item.available++;
                        let message = `Makasih ya, sudah mengembalikan <b>${item.name}</b>.`;
                        if(penalty > 0){
                            message += `<br><br>Eits, kamu kena denda keterlambatan <b>Rp ${penalty.toLocaleString('id-ID')}</b> nih. Lapor ke TU ya!`
                        }
                        App.utils.showNotification('Barang Sudah Kembali', message);
                        App.render.kembalikan();
                    }
                },
            },

            // Fungsi untuk Merender Tampilan
            render: {
                sidebar() {
                    const navLinks = [
                        { id: 'dashboard', text: 'Beranda', icon: ICONS.dashboard, roles: ['admin', 'guru', 'siswa'] },
                        { id: 'pinjam', text: 'Pinjam Barang', icon: ICONS.archive, roles: ['guru', 'siswa'] },
                        { id: 'kembalikan', text: 'Kembalikan Barang', icon: ICONS.kembalikan, roles: ['admin', 'guru', 'siswa'] },
                        { id: 'riwayat', text: 'Catatan Peminjaman', icon: ICONS.history, roles: ['admin', 'guru', 'siswa'] },
                        { id: 'laporan', text: 'Laporan TU', icon: ICONS.file_text, roles: ['admin'] },
                        { id: 'tanya_ai', text: 'Tanya Kakak AI', icon: ICONS.brain_circuit, roles: ['admin', 'guru', 'siswa'], isSpecial: true },
                        { id: 'panduan', text: 'Panduan Aplikasi', icon: ICONS.help, roles: ['admin', 'guru', 'siswa'] },
                    ];

                    App.DOM.sidebarNav.innerHTML = navLinks
                        .filter(link => link.roles.includes(App.state.currentUser.role))
                        .map(link => `
                            <a href="#" class="sidebar-link ${link.isSpecial ? 'rainbow-animate' : ''}" data-view="${link.id}">
                                <span class="mr-3">${link.icon}</span>
                                <span>${link.text}</span>
                            </a>
                        `).join('');
                    
                    document.querySelectorAll('.sidebar-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            App.logic.navigateTo(link.dataset.view);
                        });
                    });
                },

                userProfile() {
                    App.DOM.userProfile.innerHTML = `
                        ${ICONS.user}
                        <div>
                            <p class="font-semibold text-gray-800">${App.state.currentUser.name}</p>
                            <p class="text-sm text-gray-500 capitalize">${App.state.currentUser.role}</p>
                        </div>
                    `;
                },

                dashboard() {
                    const randomFact = schoolData.funFacts[Math.floor(Math.random() * schoolData.funFacts.length)];
                    const announcement = schoolData.announcements[Math.floor(Math.random() * schoolData.announcements.length)];
                    App.DOM.mainContent.innerHTML = `
                        <div class="space-y-6">
                            <div>
                                <h2 class="text-3xl font-bold text-white mb-2" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">${App.utils.getGreeting()}, ${App.state.currentUser.name}!</h2>
                                <p class="text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">${App.utils.getGreetingSubtext()}</p>
                            </div>
                            
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Pengumuman Sekolah -->
                                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-md lg:col-span-2">
                                    <h3 class="font-bold text-xl text-blue-600 mb-3">${announcement.icon} Pengumuman Sekolah</h3>
                                    <p class="font-semibold text-gray-800">${announcement.title}</p>
                                    <p class="text-gray-700">${announcement.content}</p>
                                </div>
                                
                                <!-- Wawasan Keren -->
                                <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-md">
                                    <h3 class="font-bold text-xl text-indigo-600 mb-3">ðŸ’¡ Wawasan Keren</h3>
                                    <p class="text-gray-700">${randomFact}</p>
                                </div>
                            </div>
                        </div>
                    `;
                },

                pinjam() {
                    const userRole = App.state.currentUser.role;
                    const borrowLimit = schoolConfig.borrowLimits[userRole];
                    const currentBorrows = App.state.loans.filter(
                        l => l.userId === App.state.currentUser.id && l.returnDate === null
                    ).length;
                    const canBorrowMore = currentBorrows < borrowLimit;

                    const limitInfoHtml = `
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6" role="alert">
                            <p class="font-bold">Kuota Peminjaman Kamu</p>
                            <p>Saat ini kamu sudah meminjam <strong>${currentBorrows} dari ${borrowLimit}</strong> barang yang diizinkan.</p>
                        </div>
                    `;

                    let itemsHtml = App.state.items.map(item => `
                        <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center text-center">
                            <div class="text-blue-500 mb-3">${ICONS[item.icon] || ICONS.archive}</div>
                            <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
                            <p class="text-gray-500 text-sm mb-3">Sisa: ${item.available} / ${item.total}</p>
                            <button class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                onclick="App.logic.pinjamItem('${item.id}')" ${item.available === 0 || !canBorrowMore ? 'disabled' : ''}>
                                ${item.available === 0 ? 'Lagi Dipakai' : (canBorrowMore ? 'Pinjam' : 'Kuota Penuh')}
                            </button>
                        </div>
                    `).join('');

                    App.DOM.mainContent.innerHTML = `
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pilih Barang</h2>
                            ${limitInfoHtml}
                            ${!canBorrowMore ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-6" role="alert"><p>Kamu tidak bisa meminjam barang lagi sampai ada barang yang dikembalikan.</p></div>` : ''}
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">${itemsHtml}</div>
                        </div>
                    `;
                },

                kembalikan() {
                    const loansToReturn = App.state.loans.filter(l => 
                        (App.state.currentUser.role === 'admin' || l.userId === App.state.currentUser.id) && l.returnDate === null
                    ).sort((a,b) => a.dueDate - b.dueDate);

                    let loansHtml = loansToReturn.map(loan => {
                        const item = App.state.items.find(i => i.id === loan.itemId);
                        const user = schoolData.users.find(u => u.id === loan.userId);
                        const isLate = new Date() > loan.dueDate;
                        return `
                            <tr class="border-b ${isLate ? 'bg-red-50' : ''}">
                                <td class="py-3 px-4">${item.name}</td>
                                ${App.state.currentUser.role === 'admin' ? `<td class="py-3 px-4">${user.name}</td>` : ''}
                                <td class="py-3 px-4 font-semibold ${isLate ? 'text-red-600' : ''}">${App.utils.formatDate(loan.dueDate)}</td>
                                <td class="py-3 px-4"><button class="bg-green-500 text-white text-sm font-semibold py-1 px-3 rounded-lg hover:bg-green-600" onclick="App.logic.kembalikanItem('${loan.loanId}')">Kembalikan</button></td>
                            </tr>`;
                    }).join('');
            
                    if (loansToReturn.length === 0) {
                        loansHtml = `<tr><td colspan="4" class="text-center py-8 text-gray-500">Aman! Gak ada barang yang sedang kamu pinjam.</td></tr>`;
                    }

                    App.DOM.mainContent.innerHTML = `
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-6">Kembalikan Barang</h2>
                            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                                <table class="w-full text-sm text-left text-gray-600">
                                    <thead class="bg-slate-100 text-xs text-gray-700 uppercase">
                                        <tr>
                                            <th class="py-3 px-4">Nama Barang</th>
                                            ${App.state.currentUser.role === 'admin' ? '<th class="py-3 px-4">Peminjam</th>' : ''}
                                            <th class="py-3 px-4">Jatuh Tempo</th>
                                            <th class="py-3 px-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>${loansHtml}</tbody>
                                </table>
                            </div>
                        </div>`;
                },
                
                riwayat() { /* Implementasi sama seperti sebelumnya, disesuaikan dengan struktur App */ },
                laporan() { /* Implementasi sama seperti sebelumnya, disesuaikan dengan struktur App */ },
                tanya_ai() { /* Implementasi sama seperti sebelumnya, disesuaikan dengan struktur App */ },
                panduan() { /* Implementasi sama seperti sebelumnya, disesuaikan dengan struktur App */ },

            },
            
            // Fungsi Bantuan
            utils: {
                showNotification(title, message) {
                    App.DOM.modalTitle.textContent = title;
                    App.DOM.modalMessage.innerHTML = message;
                    App.DOM.modal.classList.add('show');
                },
                formatDate(date) {
                    return date.toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                },
                calculatePenalty(loan) {
                    if (loan.returnDate || new Date() <= loan.dueDate) return 0;
                    const diffTime = Math.abs(new Date() - loan.dueDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays * schoolConfig.penaltyPerDay;
                },
                getGreeting() {
                    const hour = new Date().getHours();
                    if (hour < 11) return "Selamat Pagi";
                    if (hour < 15) return "Selamat Siang";
                    if (hour < 18) return "Selamat Sore";
                    return "Selamat Malam";
                },
                 getGreetingSubtext() {
                    const hour = new Date().getHours();
                    if (hour < 11) return "Jangan lupa sarapan dan semangat belajar ya!";
                    if (hour < 15) return "Sudah masuk jam istirahat, jangan lupa jajan di kantin!";
                    if (hour < 18) return "Sudah waktunya pulang, hati-hati di jalan!";
                    return "Waktunya istirahat, jangan begadang ya!";
                },
                makeDraggable(element) {
                    let isDragging = false, offsetX, offsetY;
                    element.onmousedown = (e) => {
                        isDragging = true;
                        offsetX = e.clientX - element.getBoundingClientRect().left;
                        offsetY = e.clientY - element.getBoundingClientRect().top;
                        element.classList.add('dragging');
                        e.preventDefault();
                    };
                    document.onmousemove = (e) => {
                        if (!isDragging) return;
                        let newX = e.clientX - offsetX;
                        let newY = e.clientY - offsetY;
                        const maxX = window.innerWidth - element.offsetWidth;
                        const maxY = window.innerHeight - element.offsetHeight;
                        element.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
                        element.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
                        element.style.bottom = 'auto';
                        element.style.right = 'auto';
                    };
                    document.onmouseup = () => {
                        isDragging = false;
                        element.classList.remove('dragging');
                    };
                },
                setupCustomCursor() {
                    const cursorDot = document.getElementById('cursor-dot');
                    const cursorOutline = document.getElementById('cursor-outline');

                    window.addEventListener('mousemove', (e) => {
                        const posX = e.clientX;
                        const posY = e.clientY;

                        cursorDot.style.left = `${posX}px`;
                        cursorDot.style.top = `${posY}px`;
                        
                        anime({
                            targets: '#cursor-outline',
                            left: `${posX}px`,
                            top: `${posY}px`,
                            duration: 400,
                            easing: 'easeOutExpo'
                        });
                    });
                },
                setupButtonClickAnimation() {
                    document.addEventListener('mousedown', (e) => {
                        if (e.target.matches('button, .sidebar-link, [onclick]')) {
                            anime({
                                targets: e.target,
                                scale: [
                                    { value: 0.95, duration: 100, easing: 'easeOutQuad' },
                                    { value: 1, duration: 200, easing: 'easeOutBack' }
                                ]
                            });
                        }
                    });
                },
                 getAIResponse(question) {
                    const q = question.toLowerCase();
                    if (q.includes('sejarah') || q.includes('berdiri')) return "SMAN 1 Dramaga didirikan pada tahun 1983. Awalnya, sekolah ini menumpang di gedung SMPN 1 Dramaga, tapi sekarang sudah jadi sekolah kebanggaan kita semua!";
                    if (q.includes('visi') || q.includes('misi')) return "Visi sekolah kita adalah 'Terwujudnya Lulusan yang Unggul dalam Prestasi, Berkarakter, dan Berwawasan Lingkungan'. Keren kan!";
                    if (q.includes('kepala sekolah') || q.includes('kepsek')) return "Kepala Sekolah kita saat ini adalah Bapak Bambang Supriyadi, S.Pd. Beliau asyik dan peduli banget sama kita-kita.";
                    if (q.includes('ekskul') || q.includes('ekstrakurikuler')) return "Banyak banget! Ada Paskibra (KOPASDRA), Pramuka, KIR, Futsal, Basket, Voli, Paduan Suara, dan English Club. Kamu ikut yang mana?";
                    if (q.includes('jam pelajaran') || q.includes('masuk jam berapa')) return "Bel masuk bunyi jam 07:00 pagi. Pulang jam 15:30 untuk Senin-Kamis, dan jam 14:00 khusus hari Jumat.";
                    if (q.includes('perpus') || q.includes('perpustakaan')) return "Perpustakaan buka dari jam 07:30 pagi sampai 16:00 sore. Tempatnya adem dan bukunya lengkap, lho!";
                    if (q.includes('kantin') || q.includes('jajan')) return "Kantin ada di deket lapangan basket. Jajanannya macem-macem, dari batagor sampai es teh legendaris Bu Kantin ada semua!";
                    if (q.includes('halo') || q.includes('hai')) return `Halo juga, ${App.state.currentUser.name}! Ada yang bisa dibantu? Tanya aja, santai.`;
                    return "Waduh, aku belum diajarin soal itu. Coba tanya tentang 'sejarah sekolah' atau 'ekskul' deh, aku jago kalau soal itu!";
                }
            }
        };

        // Inisialisasi Aplikasi ketika DOM siap
        document.addEventListener('DOMContentLoaded', () => App.init());

        // Menambahkan fungsi render yang belum ada
        App.render.riwayat = function() {
            let userLoans = (App.state.currentUser.role === 'admin') 
                ? [...App.state.loans] 
                : App.state.loans.filter(l => l.userId === App.state.currentUser.id);
            userLoans.sort((a, b) => b.borrowDate - a.borrowDate);

            const loansHtml = userLoans.map(loan => {
                const item = App.state.items.find(i => i.id === loan.itemId);
                const user = schoolData.users.find(u => u.id === loan.userId);
                const isLate = !loan.returnDate && new Date() > loan.dueDate;
                
                let statusBadge;
                if (loan.returnDate) {
                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Sudah Kembali</span>`;
                } else if (isLate) {
                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Telat</span>`;
                } else {
                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Dipinjam</span>`;
                }

                return `<tr class="border-b">
                            <td class="py-3 px-4">${item.name}</td>
                            ${App.state.currentUser.role === 'admin' ? `<td class="py-3 px-4">${user.name}</td>` : ''}
                            <td class="py-3 px-4">${App.utils.formatDate(loan.borrowDate)}</td>
                            <td class="py-3 px-4">${loan.returnDate ? App.utils.formatDate(loan.returnDate) : 'Masih dipinjam'}</td>
                            <td class="py-3 px-4">${statusBadge}</td>
                        </tr>`;
            }).join('') || `<tr><td colspan="5" class="text-center py-8 text-gray-500">Belum ada catatan peminjaman.</td></tr>`;

            App.DOM.mainContent.innerHTML = `<div>
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Catatan Peminjaman</h2>
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="bg-slate-100 text-xs text-gray-700 uppercase">
                        <tr>
                            <th class="py-3 px-4">Nama Barang</th>
                            ${App.state.currentUser.role === 'admin' ? '<th class="py-3 px-4">Peminjam</th>' : ''}
                                <th class="py-3 px-4">Tgl Pinjam</th>
                                <th class="py-3 px-4">Tgl Kembali</th>
                                <th class="py-3 px-4">Status</th>
                            </tr>
                        </thead>
                        <tbody>${loansHtml}</tbody>
                    </table>
                </div>
            </div>`;
        };

        App.render.laporan = function() {
            if (App.state.currentUser.role !== 'admin') {
                App.DOM.mainContent.innerHTML = `<p>Hanya tim TU yang boleh buka halaman ini.</p>`;
                return;
            }

            // --- Logika untuk mempersiapkan data tabel ---

            // 1. Data untuk Tabel Status Peminjaman
            const returnedLoans = App.state.loans.filter(l => l.returnDate !== null).length;
            const activeLoans = App.state.loans.length - returnedLoans;
            const totalLoans = App.state.loans.length;

            // 2. Data untuk Tabel Barang Populer
            const itemLoanCounts = {};
            App.state.loans.forEach(loan => {
                const item = App.state.items.find(i => i.id === loan.itemId);
                if (item) {
                    itemLoanCounts[item.name] = (itemLoanCounts[item.name] || 0) + 1;
                }
            });
            const sortedItems = Object.entries(itemLoanCounts).sort((a, b) => b[1] - a[1]);

            // --- HTML untuk Tabel ---

            const statusTableHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">Status Peminjaman</h3>
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-slate-100 text-xs text-gray-700 uppercase">
                            <tr><th class="py-3 px-4">Kategori</th><th class="py-3 px-4">Jumlah</th></tr>
                        </thead>
                        <tbody>
                            <tr class="border-b"><td class="py-3 px-4">Sudah Dikembalikan</td><td class="py-3 px-4">${returnedLoans}</td></tr>
                            <tr class="border-b"><td class="py-3 px-4">Sedang Dipinjam</td><td class="py-3 px-4">${activeLoans}</td></tr>
                            <tr class="font-bold bg-slate-50"><td class="py-3 px-4">Total Transaksi</td><td class="py-3 px-4">${totalLoans}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            const popularItemsTableHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">Barang Paling Sering Dipinjam</h3>
                    <table class="w-full text-sm text-left text-gray-600">
                         <thead class="bg-slate-100 text-xs text-gray-700 uppercase">
                            <tr>
                                <th class="py-3 px-4">Peringkat</th>
                                <th class="py-3 px-4">Nama Barang</th>
                                <th class="py-3 px-4">Total Dipinjam</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedItems.map((item, index) => `
                                <tr class="border-b">
                                    <td class="py-3 px-4 font-bold">${index + 1}</td>
                                    <td class="py-3 px-4">${item[0]}</td>
                                    <td class="py-3 px-4">${item[1]} kali</td>
                                </tr>
                            `).join('') || `<tr><td colspan="3" class="text-center py-4">Belum ada data.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
            
             App.DOM.mainContent.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Laporan Peminjaman Barang</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${statusTableHtml}
                        ${popularItemsTableHtml}
                    </div>
                </div>`;
        };

        App.render.panduan = function() {
            App.DOM.mainContent.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Buku Panduan SIPINJOL</h2>
                    <div class="space-y-6 bg-white p-6 rounded-xl shadow-md">
                        <div>
                            <h3 class="text-xl font-bold mb-2">1. Absen & Beranda</h3>
                            <p>Masuk pakai akunmu. Di Beranda, kamu akan disambut sapaan hangat dan ada papan pengumuman sekolah.</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">2. Pinjam & Kembalikan</h3>
                            <p>Pilih 'Pinjam Barang' buat cari barang. Kalau sudah selesai, balikin lewat menu 'Kembalikan Barang'. Gampang kan?</p>
                        </div>
                         <div>
                            <h3 class="text-xl font-bold mb-2">3. Tanya Kakak AI</h3>
                            <p>Kalau bingung soal sekolah, tanya aja ke 'Kakak AI'. Dia tahu banyak hal, dari sejarah sekolah sampai info ekskul.</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">4. Kartu Pelajar Digital</h3>
                            <p>Kartu profilmu di pojok kanan bawah itu ibarat kartu pelajar. Kerennya, bisa kamu geser-geser sesuka hati!</p>
                        </div>
                    </div>
                </div>`;
        };

        App.render.tanya_ai = function() {
            App.DOM.mainContent.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Tanya Kakak AI</h2>
                    <p class="text-gray-600 mb-6">Asisten virtual sekolah yang siap bantu kamu.</p>
                    
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div id="ai-response-area" class="h-96 bg-slate-100 rounded-lg p-4 mb-4 overflow-y-auto text-gray-700 leading-relaxed">
                            <p><strong>Kakak AI:</strong> Halo! Aku asisten AI SMAN 1 Dramaga. Ada yang bisa dibantu? Tanya aja soal ekskul, sejarah sekolah, atau lokasi kantin!</p>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="ai-question-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ketik pertanyaanmu...">
                            <button id="ai-ask-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Kirim</button>
                        </div>
                    </div>
                </div>`;

            const askBtn = document.getElementById('ai-ask-btn');
            const questionInput = document.getElementById('ai-question-input');
            const responseArea = document.getElementById('ai-response-area');

            const askAI = () => {
                const question = questionInput.value.trim();
                if (!question) return;

                responseArea.innerHTML += `<p class="mt-2 text-right"><strong>Kamu:</strong> ${question}</p>`;
                questionInput.value = '';

                const typing = document.createElement('p');
                typing.innerHTML = `<strong>Kakak AI:</strong> Ngetik...`;
                responseArea.appendChild(typing);
                responseArea.scrollTop = responseArea.scrollHeight;

                setTimeout(() => {
                    const answer = App.utils.getAIResponse(question);
                    typing.remove();
                    responseArea.innerHTML += `<p class="mt-2"><strong>Kakak AI:</strong> ${answer}</p>`;
                    responseArea.scrollTop = responseArea.scrollHeight;
                }, 1200);
            };

            askBtn.addEventListener('click', askAI);
            questionInput.addEventListener('keypress', (e) => e.key === 'Enter' && askAI());
        };

    </script>
</body>
</html>